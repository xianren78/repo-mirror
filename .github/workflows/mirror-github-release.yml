name: Mirror repos + releases (stable)

on:
  workflow_dispatch:
  schedule:
    - cron: "41 2 * * 0"  # UTC 02:41 (JST 11:41)

permissions:
  contents: write

concurrency:
  group: mirror-with-releases
  cancel-in-progress: false

jobs:
  mirror:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # ====== 你的仓库列表（示例，按需继续加）======
          - { src: "https://github.com/sbwml/openwrt-llvm-toolchain", dst: "openwrt-llvm-toolchain" }
          - { src: "https://github.com/sbwml/openwrt_caches",              dst: "openwrt_caches" }
          # =================================================

    steps:
      - name: Mirror repo + releases/assets
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          DST_OWNER: xianren78   # TODO: 改成你的 GitHub 用户名/组织名
          SRC_URL: ${{ matrix.src }}
          DST_REPO: ${{ matrix.dst }}
        run: |
          set -euo pipefail
          [ -n "${GH_PAT}" ] || (echo "GH_PAT is empty (missing Actions secret?)"; exit 1)

          echo "==> SRC: ${SRC_URL}"
          echo "==> DST: ${DST_OWNER}/${DST_REPO}"

          API="https://api.github.com"
          AUTH="Authorization: token ${GH_PAT}"

          # 解析源仓库 owner/repo
          SRC_PATH="${SRC_URL#https://github.com/}"
          SRC_PATH="${SRC_PATH%.git}"
          SRC_OWNER="${SRC_PATH%%/*}"
          SRC_REPO="${SRC_PATH#*/}"

          # 1) 创建目标仓库（不存在才创建）
          if curl -fsSL -H "${AUTH}" "${API}/orgs/${DST_OWNER}" >/dev/null 2>&1; then
            CREATE_URL="${API}/orgs/${DST_OWNER}/repos"
            CREATE_BODY=$(jq -nc --arg name "${DST_REPO}" '{name:$name, private:false}')
          else
            CREATE_URL="${API}/user/repos"
            CREATE_BODY=$(jq -nc --arg name "${DST_REPO}" '{name:$name, private:false}')
          fi

          if curl -fsSL -H "${AUTH}" "${API}/repos/${DST_OWNER}/${DST_REPO}" >/dev/null 2>&1; then
            echo "Repo exists: ${DST_OWNER}/${DST_REPO}"
          else
            echo "Creating repo: ${DST_OWNER}/${DST_REPO}"
            curl -fsSL -X POST -H "${AUTH}" -H "Content-Type: application/json" \
              -d "${CREATE_BODY}" "${CREATE_URL}" >/dev/null
          fi

          # 2) git 同步（heads + tags），排除 refs/pull/*
          work="$(mktemp -d)"
          trap 'rm -rf "$work"' EXIT

          repo_dir="${work}/repo.git"
          rm -rf "${repo_dir}"

          # 清理 runner 可能注入的 github 认证头，避免干扰
          git config --global --unset-all http.https://github.com/.extraheader || true
          git config --global credential.helper ""
          git config --global user.email "actions@github.com"
          git config --global user.name  "github-actions[bot]"

          dst_url="https://x-access-token:${GH_PAT}@github.com/${DST_OWNER}/${DST_REPO}.git"

          git clone --mirror "${SRC_URL}" "${repo_dir}"
          cd "${repo_dir}"

          git for-each-ref --format='%(refname)' refs/pull | xargs -r -n1 git update-ref -d
          git push --force --prune "${dst_url}" "refs/heads/*:refs/heads/*"
          git push --force --prune "${dst_url}" "refs/tags/*:refs/tags/*"

          echo "==> Git refs synced."

          # 3) 同步 Releases + Assets（用 gh，避免 curl OOM）
          export GH_TOKEN="${GH_PAT}"

          # 源 releases 拉取（最多 100 个；不够你再加分页）
          src_releases="$(curl -fsSL -H "Accept: application/vnd.github+json" \
            "${API}/repos/${SRC_OWNER}/${SRC_REPO}/releases?per_page=100")"

          cnt="$(echo "${src_releases}" | jq 'length')"
          echo "==> Source releases: ${cnt}"
          [ "${cnt}" -eq 0 ] && exit 0

          # 遍历每个 release
          echo "${src_releases}" | jq -c '.[]' | while read -r rel; do
            tag="$(echo "${rel}" | jq -r '.tag_name')"
            name="$(echo "${rel}" | jq -r '.name // empty')"
            body="$(echo "${rel}" | jq -r '.body // empty')"
            draft="$(echo "${rel}" | jq -r '.draft')"
            prerelease="$(echo "${rel}" | jq -r '.prerelease')"
            target="$(echo "${rel}" | jq -r '.target_commitish // "main"')"

            echo "---- Release tag: ${tag}"

            # 如果目标 release 不存在就创建
            if gh release view "${tag}" --repo "${DST_OWNER}/${DST_REPO}" >/dev/null 2>&1; then
              echo "Release exists on destination: ${tag}"
            else
              echo "Creating release on destination: ${tag}"
              args=( "${tag}" --repo "${DST_OWNER}/${DST_REPO}" --target "${target}" )
              [ -n "${name}" ] && args+=( --title "${name}" )
              # notes 允许为空，但 gh 需要参数存在才写
              args+=( --notes "${body}" )
              [ "${prerelease}" = "true" ] && args+=( --prerelease )
              [ "${draft}" = "true" ] && args+=( --draft )
              gh release create "${args[@]}"
            fi

            # 取目标已有 assets 名称（用于跳过同名）
            dst_assets="$(gh release view "${tag}" --repo "${DST_OWNER}/${DST_REPO}" --json assets -q '.assets[].name' 2>/dev/null || true)"

            # 同步 assets
            echo "${rel}" | jq -c '.assets[]? // empty' | while read -r a; do
              aname="$(echo "${a}" | jq -r '.name')"
              adl="$(echo "${a}" | jq -r '.browser_download_url')"

              if echo "${dst_assets}" | grep -Fxq "${aname}"; then
                echo "  - asset exists, skip: ${aname}"
                continue
              fi

              tmpfile="${work}/${tag}-${aname}"
              echo "  - downloading: ${aname}"
              curl -fL --retry 3 --retry-delay 2 -o "${tmpfile}" "${adl}"

              # 可选：避免超大文件（GitHub 单个 asset 上限 2GB）
              size="$(stat -c%s "${tmpfile}")"
              max=$((1900 * 1024 * 1024))
              if [ "${size}" -gt "${max}" ]; then
                echo "  - skip (too large > ~1.9GB): ${aname} (${size} bytes)"
                rm -f "${tmpfile}"
                continue
              fi

              echo "  - uploading: ${aname}"
              # 默认不覆盖同名（我们已经跳过同名了）；如你想强制覆盖，加 --clobber
              gh release upload "${tag}" "${tmpfile}" --repo "${DST_OWNER}/${DST_REPO}"

              rm -f "${tmpfile}"
            done
          done

          echo "==> Releases/assets synced."
