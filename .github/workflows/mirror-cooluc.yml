name: Mirror cooluc repos to GitHub

on:
  workflow_dispatch:
  schedule:
    - cron: "17 2 * * *"  # 每天 11:17 JST 左右跑一次（UTC 02:17）
permissions:
  contents: write

concurrency:
  group: mirror-cooluc
  cancel-in-progress: false

jobs:
  mirror:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { src: "https://git.cooluc.com/sbwml/package_libs_musl-libc",            dst: "package_libs_musl-libc" }
          - { src: "https://git.cooluc.com/sbwml/shortcut-fe",                       dst: "shortcut-fe" }
          - { src: "https://git.cooluc.com/sbwml/nft-fullcone",                       dst: "nft-fullcone" }
          - { src: "https://git.cooluc.com/sbwml/luci-app-dockerman",                 dst: "luci-app-dockerman" }
          - { src: "https://git.cooluc.com/sbwml/packages_utils_docker",              dst: "packages_utils_docker" }
          - { src: "https://git.cooluc.com/sbwml/packages_utils_dockerd",             dst: "packages_utils_dockerd" }
          - { src: "https://git.cooluc.com/sbwml/packages_utils_containerd",          dst: "packages_utils_containerd" }
          - { src: "https://git.cooluc.com/sbwml/packages_utils_runc",                dst: "packages_utils_runc" }
          - { src: "https://git.cooluc.com/sbwml/miniupnpd",                          dst: "miniupnpd" }
          - { src: "https://git.cooluc.com/sbwml/luci-app-upnp",                      dst: "luci-app-upnp" }
          - { src: "https://git.cooluc.com/sbwml/luci-app-sqm",                       dst: "luci-app-sqm" }
          - { src: "https://git.cooluc.com/sbwml/feeds_packages_libs_dmx_usb_module", dst: "feeds_packages_libs_dmx_usb_module" }

    steps:
      - name: Checkout (this repo)
        uses: actions/checkout@v4

      - name: Mirror one repo
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          OWNER: xianren78   # TODO: 改成你的 GitHub 用户名或组织名
          SRC: ${{ matrix.src }}
          DST: ${{ matrix.dst }}
        run: |
          set -euo pipefail
          
          echo "==> SRC: ${SRC}"
          echo "==> DST: ${OWNER}/${DST}"
          
          API="https://api.github.com"
          AUTH="Authorization: token ${GH_PAT}"
          
          # -------- 解析源仓库 owner/repo，用来读取 default_branch --------
          SRC_PATH="${SRC#https://github.com/}"
          SRC_PATH="${SRC_PATH%.git}"
          SRC_OWNER="${SRC_PATH%%/*}"
          SRC_REPO="${SRC_PATH#*/}"
          
          SRC_DEFAULT_BRANCH="$(curl -fsSL -H "${AUTH}" "${API}/repos/${SRC_OWNER}/${SRC_REPO}" | jq -r '.default_branch')"
          echo "==> Source default branch: ${SRC_DEFAULT_BRANCH}"
          
          # -------- 1) 目标仓库不存在则创建 --------
          if curl -fsSL -H "${AUTH}" "${API}/orgs/${OWNER}" >/dev/null 2>&1; then
            CREATE_URL="${API}/orgs/${OWNER}/repos"
            CREATE_BODY=$(jq -nc --arg name "${DST}" '{name:$name, private:false}')
          else
            CREATE_URL="${API}/user/repos"
            CREATE_BODY=$(jq -nc --arg name "${DST}" '{name:$name, private:false}')
          fi
          
          if curl -fsSL -H "${AUTH}" "${API}/repos/${OWNER}/${DST}" >/dev/null 2>&1; then
            echo "Repo exists: ${OWNER}/${DST}"
          else
            echo "Creating repo: ${OWNER}/${DST}"
            curl -fsSL -X POST -H "${AUTH}" -H "Content-Type: application/json" \
              -d "${CREATE_BODY}" "${CREATE_URL}" >/dev/null
          fi
          
          # -------- 2) mirror clone + mirror push（branches/tags 等）--------
          work="$(mktemp -d)"
          trap 'rm -rf "$work"' EXIT
          
          git config --global user.email "actions@github.com"
          git config --global user.name  "github-actions[bot]"
          
          echo "Cloning --mirror..."
          rm -rf "${work}/repo.git"
          git clone --mirror "${SRC}" "${work}/repo.git"
          cd "${work}/repo.git"
          
          # 删除 PR refs（GitHub 禁止 push hidden refs: refs/pull/*）
          git for-each-ref --format='%(refname)' refs/pull | xargs -r -n1 git update-ref -d
          
          # 目标 remote（用 x-access-token 最稳）
          dst_url="https://x-access-token:${GH_PAT}@github.com/${OWNER}/${DST}.git"
          git remote set-url --push origin "${dst_url}" || true
          git remote add github "${dst_url}" 2>/dev/null || true
          
          echo "Pushing --mirror..."
          # 不用 --mirror 推 refs/pull 后就不会再 hidden ref 报错；这里继续用 --mirror
          git push --mirror "${dst_url}"
          
          # -------- 3) 同步目标仓库默认分支为源默认分支 --------
          # 先确认目标确实有该分支（否则 PATCH 会失败）
          if git ls-remote --exit-code "${dst_url}" "refs/heads/${SRC_DEFAULT_BRANCH}" >/dev/null 2>&1; then
            echo "==> Setting destination default branch to: ${SRC_DEFAULT_BRANCH}"
            curl -fsSL -X PATCH -H "${AUTH}" -H "Content-Type: application/json" \
              -d "$(jq -nc --arg b "${SRC_DEFAULT_BRANCH}" '{default_branch:$b}')" \
              "${API}/repos/${OWNER}/${DST}" >/dev/null
          else
            echo "==> Skip setting default branch; branch not found on destination: ${SRC_DEFAULT_BRANCH}"
          fi
          
          echo "Done: ${OWNER}/${DST}"

